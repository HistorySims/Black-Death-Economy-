<!DOCTYPE html>
<html>
<head>
    <title>Black Death: The Verdict</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Press Start 2P', cursive;
            background-color: #2c3e50; 
            color: #ecf0f1; 
            text-align: center; 
            margin: 0; padding: 0;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            height: 100vh;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- TOP STATS BAR --- */
        #top-bar {
            background: #34495e;
            padding: 5px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 45px;
            border-bottom: 4px solid #2c3e50;
            z-index: 20;
        }
        .stat-group { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 8px; color: #bdc3c7; margin-bottom: 4px; }
        .stat-val { font-size: 10px; color: #f1c40f; }

        /* --- GAME CONTAINER --- */
        #game-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #2c3e50;
            position: relative;
        }
        canvas { 
            width: 100%;
            height: 100%;
            background-color: #87CEEB;
            image-rendering: pixelated; 
        }

        /* --- PLAGUE BANNER --- */
        #plague-ticker {
            position: absolute;
            top: 10px; width: 100%;
            text-align: center;
            color: #c0392b; font-size: 12px;
            display: none;
            text-shadow: 1px 1px 0 #fff;
            pointer-events: none;
        }

        /* --- GAME OVER OVERLAY --- */
        #game-over-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .result-title { font-size: 20px; color: #f1c40f; margin-bottom: 10px; text-shadow: 2px 2px #000; }
        .result-rank { font-size: 12px; color: #ecf0f1; margin-bottom: 20px; }
        
        .leaderboard {
            background: #34495e;
            border: 2px solid #ecf0f1;
            padding: 10px;
            width: 80%;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .lb-row {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #7f8c8d;
        }
        .lb-row.player { color: #f1c40f; font-weight: bold; }

        #restart-btn {
            font-family: 'Press Start 2P', cursive;
            padding: 15px 20px;
            background: #27ae60; color: white;
            border: 4px solid #2ecc71;
            font-size: 14px;
            cursor: pointer;
            width: 200px;
        }
        #restart-btn:active { transform: translateY(4px); }

        /* --- BOTTOM CONTROLS --- */
        #controls-bar {
            background: #2c3e50;
            height: 120px; 
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 20px; 
        }
        
        .control-panel {
            background: #34495e;
            border-radius: 15px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 20px;
            border: 2px solid #ecf0f1;
        }

        button { 
            font-family: 'Press Start 2P', cursive;
            width: 80px; height: 70px;
            font-size: 30px; cursor: pointer; 
            background: #e67e22; color: white; border: none;
            border-radius: 10px;
            box-shadow: 0 6px #d35400;
            touch-action: manipulation;
        }
        button:active { 
            box-shadow: 0 0 #d35400; 
            transform: translateY(6px); 
        }

        #rent-display-box { text-align: center; width: 100px; }
        .rent-label { font-size: 8px; color: #bdc3c7; display: block; margin-bottom: 8px; }
        #rentDisplay { font-size: 24px; color: white; }

        #month-bar-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #2c3e50;
        }
        #month-bar { width: 0%; height: 100%; background: #2ecc71; transition: width 0.1s linear; }
#homeBtn{
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 9999;
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
  padding: 10px 10px;
  background: rgba(0,0,0,0.35);
  color: #fff;
  border: 3px solid rgba(255,255,255,0.25);
  border-radius: 10px;
  text-decoration: none;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
#homeBtn:active{ transform: translateY(2px); }
    </style>
</head>
<body>
<a id="homeBtn" href="index.html" aria-label="Return to launcher">HOME</a>
    <div id="top-bar">
        <div class="stat-group">
            <span class="stat-label">DATE</span>
            <span class="stat-val" id="dateDisplay">Jan 1345</span>
        </div>
        <div class="stat-group">
            <span class="stat-label">POPULATION</span>
            <span class="stat-val" id="popDisplay" style="color:white">35</span>
        </div>
        <div class="stat-group">
            <span class="stat-label">MY WEALTH</span>
            <span class="stat-val" id="wealthDisplay" style="color:#2ecc71; font-size:12px;">0g</span>
        </div>
        <div class="stat-group">
            <span class="stat-label">AVG RENT</span>
            <span class="stat-val" id="avgRentDisplay" style="color:#3498db">45g</span>
        </div>
    </div>

    <div id="game-container">
        <div id="plague-ticker">THE PLAGUE HAS ARRIVED</div>
        
        <div id="game-over-screen">
            <div class="result-title" id="final-title">GAME OVER</div>
            <div class="result-rank" id="final-rank">You placed #2</div>
            <div class="leaderboard" id="leaderboard">
                </div>
            <button id="restart-btn" onclick="restartGame()">PLAY AGAIN</button>
        </div>

        <div id="month-bar-container"><div id="month-bar"></div></div>
        <canvas id="gameCanvas" width="900" height="500"></canvas>
    </div>

    <div id="controls-bar">
        <div class="control-panel">
            <button ontouchstart="adjustRent(-1)" onmousedown="adjustRent(-1)">-</button>
            <div id="rent-display-box">
                <span class="rent-label">SET RENT</span>
                <span id="rentDisplay">45g</span>
            </div>
            <button ontouchstart="adjustRent(1)" onmousedown="adjustRent(1)">+</button>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // --- ASSETS ---
    const C = {
        sky: '#87CEEB', hills: '#27ae60', ground: '#7f8c8d', cobble: '#95a5a6',
        timber: '#5c4033', wall: '#fdf5e6', roof: '#c0392b', 
        winLit: '#f1c40f', winDark: '#2c3e50',
        playerHighlight: '#f39c12'
    };
    
    const PALETTE = {
        skin: ['#fceabb', '#ffdbac', '#e0ac69'],
        hair: ['#2c3e50', '#8e44ad', '#d35400', '#f1c40f', '#5d4037'],
        clothes: ['#3498db', '#e74c3c', '#2ecc71', '#9b59b6', '#f39c12', '#ecf0f1', '#34495e'],
        sickSkin: '#00ff00' 
    };

    const GROUND_Y = 400;
    const MONTH_FRAMES = 120; 
    const PLAYER_HOUSE_IDX = 2;
    const END_YEAR = 1352; // Game ends here

    // --- STATE ---
    let state = {
        year: 1346, 
        month: 0, 
        monthTimer: 0,
        isPlague: false,
        gameActive: true,
        playerRent: 45,
        avgRent: 45,
        population: [],
        houses: [],
        floatingTexts: [],
        hills: [],
        targetPop: 35
    };

    // --- CLASSES ---
    class FloatingText {
        constructor(x, y, text, color) {
            this.x = x; this.y = y; this.text = text; this.color = color;
            this.life = 50; 
        }
        draw() {
            ctx.fillStyle = this.color;
            ctx.font = "14px 'Press Start 2P'";
            ctx.fillText(this.text, this.x, this.y);
            this.y -= 0.8; this.life--;
        }
    }

    class House {
        constructor(x, index, isPlayer) {
            this.x = x; this.y = GROUND_Y; this.w = 140; this.h = 170;
            this.isPlayer = isPlayer;
            this.index = index;
            this.slots = 5;
            this.tenants = [];
            this.price = isPlayer ? 45 : Math.floor(Math.random() * 10 + 40);
            this.wealth = 0;
            this.aiTimer = 0;
            
            // AI Names
            if(index === 0) { this.aiType = 'undercutter'; this.name = "The Cutter"; }
            if(index === 1) { this.aiType = 'follower'; this.name = "The Sheep"; }
            if(index === 2) { this.aiType = 'player'; this.name = "YOU"; }
            if(index === 3) { this.aiType = 'gouger'; this.name = "The Miser"; }
            if(index === 4) { this.aiType = 'wildcard'; this.name = "The Jester"; }
        }

        get occupancy() { return this.tenants.length; }

        addTenant(person) {
            if(this.occupancy < this.slots) {
                this.tenants.push(person);
                return true;
            }
            return false;
        }

        removeTenant(person) {
            this.tenants = this.tenants.filter(t => t !== person);
        }

        updateAI() {
            if(this.isPlayer) return;
            this.aiTimer++;
            if(this.aiTimer > 30) { 
                this.aiTimer = 0;
                let marketMean = state.avgRent;
                
                switch(this.aiType) {
                    case 'undercutter': this.price = Math.max(5, marketMean - 3); break;
                    case 'follower': 
                        if(this.price > marketMean) this.price--;
                        else if(this.price < marketMean) this.price++;
                        break;
                    case 'gouger': 
                        if(this.occupancy === 0) this.price = Math.max(5, marketMean);
                        else this.price = marketMean + 4;
                        break;
                    case 'wildcard': 
                        if(Math.random() > 0.6) this.price += Math.floor(Math.random()*5 - 2);
                        break;
                }
                
                if(this.occupancy === 0) this.price = Math.max(2, this.price - 1);
                this.price = Math.floor(this.price);
            }
        }

        collectRent() {
            let income = 0;
            for (let i = this.tenants.length - 1; i >= 0; i--) {
                let t = this.tenants[i];
                if(t.budget < this.price) t.evict();
                else income += this.price;
            }
            if(income > 0) {
                this.wealth += income;
                if(this.isPlayer) {
                    state.floatingTexts.push(new FloatingText(this.x + 60, this.y - 120, `+${income}`, '#f1c40f'));
                    updateUI();
                }
            }
        }

        draw() {
            let hx = this.x; let hy = this.y - this.h;
            
            drawRect(hx, this.y-20, this.w, 20, '#7f8c8d');
            drawRect(hx, hy, this.w, this.h-20, C.wall);
            ctx.fillStyle = C.roof;
            ctx.beginPath(); ctx.moveTo(hx - 10, hy); ctx.lineTo(hx + this.w/2, hy - 90); ctx.lineTo(hx + this.w + 10, hy); ctx.fill();
            ctx.lineWidth = 4; ctx.strokeStyle = C.timber; ctx.stroke();
            
            drawRect(hx, hy, 10, this.h-20, C.timber); drawRect(hx+this.w-10, hy, 10, this.h-20, C.timber);
            drawRect(hx, hy + 60, this.w, 10, C.timber); drawRect(hx, hy + 120, this.w, 10, C.timber);

            // Wealth Tag
            if(!this.isPlayer) {
                ctx.fillStyle = "rgba(255,255,255,0.7)"; 
                ctx.fillRect(hx + 35, hy - 110, 50, 14);
                ctx.fillStyle = "black"; 
                ctx.font = "10px 'Press Start 2P'";
                ctx.fillText(this.wealth + "g", hx + 40, hy - 100);
            }

            for(let i=0; i<this.slots; i++) {
                let winX = hx + 20 + (i%3)*40;
                let winY = hy + 80;
                if(i >= 3) { winX = hx + 35 + (i%2)*40; winY = hy + 20; }
                
                let isOccupied = i < this.occupancy;
                drawRect(winX, winY, 24, 30, C.timber);
                drawRect(winX+2, winY+2, 20, 26, isOccupied ? C.winLit : C.winDark);
                if(isOccupied) {
                    let tenant = this.tenants[i];
                    drawRect(winX+6, winY+14, 12, 12, tenant.skinColor);
                }
            }

            drawRect(hx+this.w/2 - 25, hy+150, 50, 20, '#ecf0f1');
            ctx.fillStyle = '#2c3e50'; ctx.font = "10px 'Press Start 2P'";
            ctx.fillText(this.price + "g", hx+this.w/2 - 15, hy+165);

            if(this.isPlayer) {
                ctx.strokeStyle = C.playerHighlight; ctx.lineWidth = 5;
                ctx.strokeRect(hx-3, hy-3, this.w+6, this.h-14);
            }
        }
    }

    class Person {
        constructor() { this.reset(true); }
        reset(isSpawn) {
            this.x = Math.random() * 800 + 50; 
            this.y = GROUND_Y - 2;
            this.speed = 1.0 + Math.random() * 1.5; 
            this.direction = Math.random() > 0.5 ? 1 : -1;
            this.isSick = false; this.sickTimer = 0; 
            this.gender = Math.random() > 0.5 ? 'f' : 'm';
            this.skinColor = PALETTE.skin[Math.floor(Math.random()*3)];
            this.hairColor = PALETTE.hair[Math.floor(Math.random()*5)];
            this.clothesColor = PALETTE.clothes[Math.floor(Math.random()*7)];
            let base = state.isPlague ? 5 : 40;
            this.budget = base + Math.floor(Math.random() * 45);
            this.house = null; this.state = 'wandering'; 
            this.targetHouse = null; this.animFrame = Math.random() * 100;
            this.patience = 0;
        }

        think() {
            if(this.state === 'wandering') {
                this.patience++;
                if(this.patience > 200) this.budget += 1;
            }
            if(this.state === 'housed') {
                this.patience = 0;
                if(this.budget > state.avgRent + 5) this.budget -= 0.1;
            }

            if(this.isSick) {
                let decay = this.state === 'housed' ? 0.5 : 1;
                this.sickTimer += decay;
                if(this.sickTimer > 100) { this.evict(); this.state = 'dying'; this.sickTimer = 0; }
            }

            if(this.state === 'dying') {
                this.sickTimer++; if(this.sickTimer > 90) this.state = 'dead';
                return;
            }

            if (this.state === 'housed') {
                if(Math.random() < 0.01) { 
                    let betterOption = state.houses.find(h => h.price < this.house.price - 5 && h.occupancy < h.slots);
                    if(betterOption) { this.evict(); this.targetHouse = betterOption; }
                }
                if(this.house && (this.house.price > this.budget)) this.evict();
                return;
            }

            if (this.state === 'leaving') { this.x += (this.speed * this.direction); return; }

            if (!this.targetHouse || this.targetHouse.occupancy >= this.targetHouse.slots) {
                let options = state.houses.filter(h => h.price <= this.budget && h.occupancy < h.slots);
                if (options.length > 0) {
                    options.sort((a,b) => a.price - b.price);
                    this.targetHouse = options[0];
                } else this.targetHouse = null;
            }

            if (this.targetHouse) {
                let tx = this.targetHouse.x + this.targetHouse.w/2;
                if (Math.abs(tx - this.x) < 5) {
                    if (this.targetHouse.addTenant(this)) {
                        this.house = this.targetHouse;
                        this.state = 'housed';
                        if(this.targetHouse.isPlayer) state.floatingTexts.push(new FloatingText(this.x, this.y-50, "!", "#2ecc71"));
                    } else this.targetHouse = null;
                } else this.x += (tx > this.x ? this.speed : -this.speed);
            } else {
                this.x += (this.speed * this.direction);
                if(this.x < 0 || this.x > 900) { this.direction *= -1; if(Math.random() < 0.2) this.reset(true); }
            }
        }

        evict() {
            if(this.house) {
                this.house.removeTenant(this);
                this.house = null;
                this.state = 'wandering'; 
                this.targetHouse = null;
                if(!this.isSick) state.floatingTexts.push(new FloatingText(this.x, this.y-60, "Moved!", "#c0392b"));
            }
        }

        draw() {
            if (this.state === 'housed' || this.state === 'dead') return;
            let px = this.x; let py = this.y;
            
            if(this.state === 'dying') {
                ctx.fillStyle = this.clothesColor; ctx.fillRect(px, py, 16, 8); 
                ctx.fillStyle = this.skinColor; ctx.fillRect(px+16, py+2, 8, 8); 
                if(this.sickTimer < 30) { ctx.fillStyle = "white"; ctx.fillText("cough", px, py-10); }
                return;
            }

            this.animFrame++;
            let walkCycle = Math.sin(this.animFrame * 0.2); 
            let legOffset = walkCycle * 4; let bob = Math.abs(walkCycle) * 2;
            
            ctx.fillStyle = '#3e2723';
            if(this.gender === 'm') {
                drawRect(px+4+legOffset, py-10, 3, 10, '#3e2723'); drawRect(px+10-legOffset, py-10, 3, 10, '#3e2723');
            } else drawRect(px+2, py-10, 14, 10, this.clothesColor); 

            py -= bob;
            drawRect(px+2, py-24, 14, 14, this.clothesColor);
            if(this.gender === 'f') drawRect(px+5, py-22, 8, 10, '#ecf0f1');
            else drawRect(px+2, py-16, 14, 3, '#2c3e50');

            ctx.fillStyle = this.clothesColor;
            let armSwing = -walkCycle * 4;
            drawRect(px-2+armSwing, py-22, 4, 10, this.clothesColor);
            drawRect(px+14-armSwing, py-22, 4, 10, this.clothesColor);
            drawRect(px-2+armSwing, py-12, 4, 3, this.skinColor);
            drawRect(px+14-armSwing, py-12, 4, 3, this.skinColor);

            drawRect(px+4, py-34, 10, 10, this.skinColor);
            ctx.fillStyle = this.hairColor;
            if(this.gender === 'f') {
                drawRect(px+3, py-35, 12, 4, this.hairColor); drawRect(px+2, py-32, 2, 8, this.hairColor);
                if(this.animFrame % 100 > 50) drawRect(px+4, py-36, 10, 3, 'white');
            } else drawRect(px+3, py-36, 12, 4, this.hairColor);
        }
    }

    // --- ENGINE ---
    function init() {
        state.year = 1345;
        state.month = 0;
        state.gameActive = true;
        state.isPlague = false;
        state.hills = [];
        state.population = [];
        state.houses = [];
        state.floatingTexts = [];
        state.playerRent = 45;

        // Hide Game Over
        document.getElementById('game-over-screen').style.display = 'none';
        document.getElementById('plague-ticker').style.display = 'none';
        C.sky = '#87CEEB';

        // Gen Hills
        for(let i=0; i<=900; i+=40) state.hills.push({x: i, y: GROUND_Y - 80 - Math.random()*25});
        
        let startX = (900 - (5 * 150)) / 2;
        for (let i = 0; i < 5; i++) state.houses.push(new House(startX + i * 150, i, i === PLAYER_HOUSE_IDX));
        for(let i=0; i<35; i++) state.population.push(new Person()); 
        
        gameLoop();
    }

    function restartGame() {
        init();
    }

    function showGameOver() {
        state.gameActive = false;
        
        // Calculate Rankings
        let rankings = [...state.houses].sort((a,b) => b.wealth - a.wealth);
        let playerRank = rankings.findIndex(h => h.isPlayer) + 1;
        
        document.getElementById('final-title').innerText = playerRank === 1 ? "VICTORY!" : "GAME OVER";
        document.getElementById('final-title').style.color = playerRank === 1 ? "#2ecc71" : "#e74c3c";
        document.getElementById('final-rank').innerText = `You ranked #${playerRank} of 5`;
        
        // Populate Leaderboard
        let html = "";
        rankings.forEach((h, idx) => {
            let className = h.isPlayer ? "lb-row player" : "lb-row";
            html += `<div class="${className}"><span>#${idx+1} ${h.name}</span><span>${h.wealth}g</span></div>`;
        });
        document.getElementById('leaderboard').innerHTML = html;
        
        document.getElementById('game-over-screen').style.display = 'flex';
    }

    function gameLoop() {
        if(!state.gameActive) return;

        state.monthTimer++;
        if(state.monthTimer >= MONTH_FRAMES) { state.monthTimer = 0; endMonth(); }

        let totalRent = 0;
        state.houses.forEach(h => { h.updateAI(); totalRent += h.price; });
        state.avgRent = Math.floor(totalRent / 5);

        if(state.isPlague) state.targetPop = 10 + Math.floor(Math.sin(Date.now()/3000) * 3);
        else state.targetPop = 34 + Math.floor(Math.sin(Date.now()/4000) * 11); 

        state.population = state.population.filter(p => p.state !== 'dead');

        if(state.population.length < state.targetPop) {
            let chance = state.isPlague ? 0.01 : 0.05; 
            if(Math.random() < chance) {
                let p = new Person();
                if(state.isPlague && Math.random() < 0.5) { p.isSick = true; p.skinColor = PALETTE.sickSkin; p.budget = 5; }
                state.population.push(p);
            }
        }
        
        if(state.population.length > state.targetPop && Math.random() < 0.02) {
            let wanderers = state.population.filter(p => p.state === 'wandering');
            if(wanderers.length > 0) wanderers[0].state = 'dead';
        }

        state.population.forEach(p => p.think());

        drawScene();
        requestAnimationFrame(gameLoop);
    }

    function endMonth() {
        state.month++;
        if(state.month > 11) {
            state.month = 0; state.year++;
            if(state.year === 1348) triggerPlague();
            if(state.year === END_YEAR) showGameOver();
        }
        state.houses.forEach(h => h.collectRent());
        updateUI();
    }

    function triggerPlague() {
        state.isPlague = true;
        document.getElementById('plague-ticker').style.display = 'block';
        C.sky = "#5e4b4b"; C.ground = "#5d4037"; C.hills = "#3e2723";
        state.population.forEach(p => {
            if(Math.random() < 0.4) { p.isSick = true; p.skinColor = PALETTE.sickSkin; p.budget = Math.max(2, p.budget - 30); }
        });
    }

    function drawScene() {
        ctx.clearRect(0, 0, 900, 500);
        
        ctx.fillStyle = C.sky; ctx.fillRect(0,0,900, GROUND_Y);
        ctx.fillStyle = C.hills; ctx.beginPath(); ctx.moveTo(0, GROUND_Y); 
        ctx.lineTo(0, GROUND_Y-80); state.hills.forEach(pt => ctx.lineTo(pt.x, pt.y));
        ctx.lineTo(900, GROUND_Y); ctx.fill();
        
        ctx.fillStyle = C.ground; ctx.fillRect(0, GROUND_Y, 900, 500-GROUND_Y);
        ctx.fillStyle = C.cobble;
        for(let y=GROUND_Y+5; y<500; y+=10) { for(let x=0; x<900; x+=25) { if((x+y)%50 === 0) drawRect(x, y, 15, 6, C.cobble); } }

        state.houses.forEach(h => h.draw());
        state.population.sort((a,b) => a.y - b.y);
        state.population.forEach(p => p.draw());
        state.floatingTexts = state.floatingTexts.filter(ft => ft.life > 0);
        state.floatingTexts.forEach(ft => ft.draw());
        
        document.getElementById('month-bar').style.width = ((state.monthTimer / MONTH_FRAMES) * 100) + "%";
    }

    function adjustRent(amount) {
        state.playerRent += amount;
        if(state.playerRent < 1) state.playerRent = 1;
        state.houses[PLAYER_HOUSE_IDX].price = state.playerRent;
        updateUI();
    }

    function updateUI() {
        document.getElementById('rentDisplay').innerText = state.playerRent + "g";
        document.getElementById('wealthDisplay').innerText = state.houses[PLAYER_HOUSE_IDX].wealth + "g";
        document.getElementById('avgRentDisplay').innerText = state.avgRent + "g";
        document.getElementById('popDisplay').innerText = state.population.length;
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        document.getElementById('dateDisplay').innerText = months[state.month] + " " + state.year;
    }

    function drawRect(x, y, w, h, color) { ctx.fillStyle = color; ctx.fillRect(Math.floor(x), Math.floor(y), w, h); }

    document.fonts.ready.then(init);

</script>
</body>
</html>

